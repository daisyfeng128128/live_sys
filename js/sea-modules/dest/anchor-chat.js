define(function(e,c,g){var a=e("cons");var d=e("./anchor-tools");var f=e("./anchor-face");var b=e("flyScreen");var h=e("toproom");g.exports={init:function(){$("#msgContent").keypress(function(j){if(j.which==13){j.preventDefault();if(!$("#sendChatBtn").attr("disabled")&&$("#sendChatBtn").is(":visible")){$("#sendChatBtn").click()}}});$(".msgContent").focus(function(){$(".cf-inputs").css({border:"1px solid #7cbcf4","box-shadow":"1px 1px 1px #bed4e7 inset"})});$(".msgContent").blur(function(){$(".cf-inputs").css("border","1px solid #c9c7ca")});$("#sendChatBtn").click(function(){if(!UIF.handler.login){UIF.handler.loging();return}var s=false;var l=$("#msgContent").val();if(l==""){try{$("#msgContent").focusInput();$("#msgContent").focus()}catch(t){}return}if(l.length>50){d.dialog("您的聊天内容过长，请确保不超过15个汉字!")}var o=UIF.handler.cache.get(a.USER_HEADIMAG);switch(UIF.handler.sendTsg){case"ALL":var v;var r=UIF.handler.cache.get(a.USER_HEADROLES);var u=UIF.handler.cache.get(a.USER_HEADINFOS);var n=UIF.handler.cache.get(a.LOCAL_TIMESENDMSG);if(u!=null&&u.anchorId!=UIF.handler.userId&&r!=null&&r.length>0){var q=jQuery.parseJSON(r);if(!d.arrayContains(q,1)&&!d.arrayContains(q,2)){v=2*1000}if(d.arrayContains(q,1)){v=1*1000}if(d.arrayContains(q,2)){v=1*1000}}var m=false;if(n!=null){var k=new Date().getTime();if((k-n)>=v){m=true;n=new Date().getTime()}}else{m=true;n=new Date().getTime()}UIF.handler.cache.put(a.LOCAL_TIMESENDMSG,n);if(m||UIF.handler.userId==UIF.handler.anchorId){if(UIF.handler.sendUserId!=null&&UIF.handler.sendUserId.length>0){UIF.handler.sendChatP2P({nickname:UIF.currentUserNickname,message:l,levs:o,toUser:UIF.handler.sendUserId},function(z){});UIF.handler.sendUserId=null}else{UIF.handler.sendChatALL({nickname:UIF.currentUserNickname,message:l,levs:o},function(z){})}s=true}else{var p=3;function y(){p--;$("#sendChatNotice").text(" ["+p+"]秒后再试");$("#sendChatNotice").show();$("#sendChatBtn").attr("disabled",true);if(p==0){clearInterval(j);$("#sendChatBtn").attr("disabled",false);$("#sendChatNotice").hide()}}var j=setInterval(y,1000)}break;case"FLY":var w=UIF.handler.cache.get(a.USER_SENDDANMU);if(!w){d.dialog("弹幕200蚪币每条!",function(z){UIF.handler.cache.put(a.USER_SENDDANMU,true);UIF.handler.sendChatFLY({nickname:UIF.currentUserNickname,message:l,levs:o},function(A){if(A.resultStatus==100){d.dialog(A.resultMessage)}})},function(z){})}if(w){UIF.handler.sendChatFLY({nickname:UIF.currentUserNickname,message:l,levs:o},function(z){if(z.resultStatus==100){d.dialog(z.resultMessage)}})}s=true;break;case"GLO":var r=UIF.handler.cache.get(a.USER_HEADROLES);if(r!=null&&r.length>0){var q=jQuery.parseJSON(r);if(d.arrayContains(q,8)){var x=UIF.handler.cache.get(a.USER_SENDNICE);if(!x){d.dialog("全站公告5000蚪币每条!",function(z){UIF.handler.cache.put(a.USER_SENDNICE,true);UIF.handler.sendChatGLO({nickname:UIF.currentUserNickname,message:l,levs:o},function(A){if(A.resultStatus==100){d.dialog(A.resultMessage)}})},function(z){})}if(x){UIF.handler.sendChatGLO({nickname:UIF.currentUserNickname,message:l,levs:o},function(z){if(z.resultStatus==100){d.dialog(z.resultMessage)}})}}else{d.dialog("全站公告需要爵位6级以上!")}}s=true;break;default:var m=false;var r=UIF.handler.cache.get(a.USER_HEADROLES);if(r!=null&&r.length>0){var q=jQuery.parseJSON(r);if(d.arrayContains(q,12)){m=true;UIF.handler.sendChatPRV({nickname:UIF.currentUserNickname,message:l,levs:o},function(z){})}}if(!m){d.dialog("向主播发送私聊消息,需要爵位达到6级以上!")}s=true;break}if(s){$("#msgContent").val("")}});$(".sdChat").mousedown(function(){$(this).addClass("sdChatBtnC")});$(".sdChat").mouseup(function(){$(this).removeClass("sdChatBtnC")});var i=0;$("#pubChatList").on("click","li .u",function(s){var q=$(this).attr("rel");var m=$(this).attr("class");if(undefined==q){return}var p=q.split(" ")[0];var o=q.split(" ")[1];var k=q.split(" ")[2]+" "+q.split(" ")[3];var l=s.pageX;var u=s.pageY;var j=$(".chat-area");var r=j[0].offsetLeft;if(k!=null&&k.indexOf("undefined")==-1){$(".levelss").html("<span class='"+k+"'></span>");$(".chat-tip-name").css("margin-left","15px");$(".levelss").show()}else{$(".levelss").hide();$(".chat-tip-name").css("margin-left","0px")}$(".chat-tip-id").html("ID："+p);$(".chat-tip-id").attr("tid",p);$(".chat-tip-name").text(o);$(".chat-tip-warp").css({left:r+20,top:u+20+"px"});var n=UIF.handler.cache.get(a.USER_HEADROLES);$(".chat-tip-kick .kick").hide();$(".chat-tip-atan .atan").hide();$(".chat-tip-jinyan .jinyan").hide();var t=UIF.handler.cache.get(a.USER_HEADINFOS);$(".chat-tip-img img").attr("src","/apis/avatar.php?uid="+p);if(t!=null&&UIF.handler.anchorId!=p&&t.userId!=p&&n!=null&&n.length>0){if(n.indexOf("12")>0){$(".chat-tip-atan .atan").show()}if(n.indexOf("13")>0||n.indexOf("14")>0||n.indexOf("15")>0){$(".chat-tip-jinyan .jinyan").show()}if(n.indexOf("16")>0||n.indexOf("17")>0||n.indexOf("18")>0){$(".chat-tip-kick .kick").show()}if(n.indexOf("18")>0&&n.indexOf("15")>0&&UIF.handler.anchorId==UIF.currentUserID){$(".setManager,.resetManager").hide();if(m.indexOf("gl")<0&&i==0){$(".setManager").show()}else{$(".resetManager").show()}$(".chat-tip-setM").show()}}$(".chat-tip-warp").show()});$(".setManager").click(function(){var j=$(".toggleBox .chat-tip-id").attr("tid");UIF.handler.roomManagers({toIds:j,drives:"adds"},function(k){k=jQuery.parseJSON(k);if(k!=null&&k.resultMessage=="success"){d.dialog("添加成功！");$(".resetManager").show();$(".setManager").hide();i=1}})});$(".resetManager").click(function(){var j=$(".toggleBox .chat-tip-id").attr("tid");UIF.handler.roomManagers({toIds:j,drives:"dels"},function(k){k=jQuery.parseJSON(k);if(k!=null&&k.resultMessage=="success"){d.dialog("删除成功！");$(".resetManager").hide();$(".setManager").show();i=0}})});$(".toggleBox").on("click",".chat-tip-atan .atan",function(l){if(!UIF.handler.login){UIF.handler.loging();return}var j=$(".toggleBox .chat-tip-id").attr("tid");var k=$(".toggleBox .chat-tip-name").text();if(j==UIF.handler.userId){d.dialog("不能自我私聊!");return}$("#msgContent").val("@"+k+":");UIF.handler.sendUserId=j;$("#msgContent").focus()});$(".chat-header .closing").click(function(){if(!UIF.handler.login){UIF.handler.loging();return}d.dialog("确定关闭此直播间，进行重新审查！",function(j){UIF.handler.censor({},function(k){})},function(j){})});$(".toggleBox").on("click",".chat-tip-bottom .jinyan",function(l){if(!UIF.handler.login){UIF.handler.loging();return}var j=$(".toggleBox .chat-tip-id").attr("tid");if(j==UIF.handler.userId){d.dialog("不能自我禁言!");return}UIF.handler.blacks({toIds:j,drives:"banned"},function(n){var m=jQuery.parseJSON(n);if(m.resultStatus==200){d.dialog("禁言成功!")}else{d.dialog("禁言失败,"+m.resultMessage)}});var k={userId:j,roomNumber:UIF.currentRoomNumber};$.ajax({type:"POST",url:"/ajax/delChatMessage.php",data:k,cache:false,dataType:"json",async:false}).done(function(m){console.log(m)})});$(".toggleBox").on("click",".chat-tip-bottom .kick",function(k){if(!UIF.handler.login){UIF.handler.loging();return}var j=$(".toggleBox .chat-tip-id").attr("tid");if(j==UIF.handler.userId){d.dialog("不能自我踢出!");return}UIF.handler.blacks({toIds:j,drives:"kickout"},function(m){var l=jQuery.parseJSON(m);if(l.resultStatus==200){d.dialog("踢出成功!")}else{d.dialog("踢出失败,"+l.resultMessage)}})});$(".toggleBox").on("click",".send-h-gift",function(n){console.log(0);if(!UIF.handler.login){UIF.handler.loging();return}var k=$(".toggleBox .chat-tip-id").attr("tid");if(k==UIF.handler.userId){d.dialog("不能自我增送礼物!");return}if(UIF.handler.newSendGiftID==0){d.dialog("请在礼物栏中选择要送出的礼物!");return}var m=$.trim($("#sendGiftNum").val());if(m<=0||!$.isNumeric(m)){d.dialog("请正确填写礼物数量");return}var j=$(".toggleBox .chat-tip-name").text();var l=$("#gift"+UIF.handler.newSendGiftID+" >span").text();d.dialog("赠送"+j+m+l,function(o){UIF.handler.sendUserGift({toUser:k,giftId:UIF.handler.newSendGiftID,number:m},function(p){d.dialog("赠送成功!")})},function(o){})});$(".son_ul li").on("click",function(){UIF.handler.sendTsg=this.id;$("#dstUserV").html($(this).text());$(".switchChat").html($(this).text());$(".changeCh").css("background",$(this).css("background"));$(".son_ul").hide()});$(".cfchange").click(function(){$(".son_ul").show();$(".switchChat").html("　");return false});$(".chat-header .chat_right").click(function(){$(".chat-header .chat_right").removeClass("issel");$(this).addClass("issel");var j=$(this).attr("ct");var k=j.charAt(j.length-1,1);$(".chat-header").siblings("div").hide();$(".ui-resizable-handle").show();$(".chs"+k).show()});this.getCacheChat(UIF.handler.roomNumber)},spimg:function(m){var l="";if(m!=null&&m.length>0){for(var k=0;k<m.length;k++){var j=m[k];if(j!=null&&j!=""&&j.indexOf("pic_consumelevel")>0){l=j;break}}}return l},headimg:function(o){var n="";if(o!=null&&o!=""&&o.length>0){var j='<span class="{0}"></span>';var k=jQuery.parseJSON(o);if(k!=null&&k.length>0){for(var m=0;m<k.length;m++){var l=k[m];if(l!=null&&l!=""){n+=d.stringFormat(j,l)}}}}return n},pclass:function(p){var o="";if(p!=null&&p.length>0){var k=jQuery.parseJSON(p);if(k!=null&&k.length>0){for(var n=0;n<k.length;n++){var m=k[n];if(m!=null&&m!=""){if(m.indexOf("pic_consumelevel")>0){var l="";var q=m.split("_consumelevel_");if(q[1]<10){l=" jv1"}else{if(q[1]>10&&q[1]<21){l=" jv2"}else{if(q[1]>20){l=" jv2"}}}o+=l}if(m.indexOf("pic_liverlevel")>0){o+=" anc"}if(m.indexOf("pic_guanli")>0){o+=" gl"}if(m.indexOf("pic_guardlevel")>0){var j="";var q=m.split("pic_guardlevel_S_");if(q[1]<6){j=" gd1"}else{if(q[1]>5&&q[1]<11){j=" gd2"}else{if(q[1]>10){j=" gd2"}}}o+=j}}}}}return o},getCacheChat:function(i){var k=this;var j={roomNumber:i};$.ajax({type:"POST",url:"/ajax/getChatMessage.php",data:j,cache:false,dataType:"json",async:false}).done(function(l){$.each(l,function(n,m){var o='<li class="fontred"><span class="gr-time">{0}</span>{1}<a href="javascript:;" class="u{2}" rel="{3} {4} {5}">{6}</a>{7}</li>';words=f.faceReplaceImg(m.message);try{m.levs=m.levs.replace(/\\/g,"")}catch(p){m.levs=""}o=d.stringFormat(o,m.ctime,k.headimg(m.levs),k.pclass(m.levs),m.userId,decodeURIComponent(m.nickname),k.spimg(m.levs),decodeURIComponent(m.nickname)+"：",words);$("#pubChatList").append(o);try{$("#nano-pubChatList").nanoScroller();$("#nano-pubChatList").nanoScroller({scroll:"bottom"})}catch(p){UIF.handler.weblog(p)}})})},visitors:function(j){if(j.nickname!=null){var i='<li class="fontred"><span>欢迎   </span><span class="u">{0} </span><span>进入房间</span></li>';i=d.stringFormat(i,decodeURIComponent(j.nickname));$("#pubChatList").append(i);try{$("#nano-pubChatList").nanoScroller();$("#nano-pubChatList").nanoScroller({scroll:"bottom"})}catch(k){UIF.handler.weblog(k)}}},welcome:function(k){if(k.userId!=null&&k.nickname!=null){if(k.numbers!=null){$(".live-info .s-else .s-people").text(k.numbers)}if(k.himage!=null){var i=k.himage}var j='<li class="fontred"><span>欢迎   </span>{0}<a href="javascript:;" class="u{1}" rel="{2} {3} {4}" data-img="{5}">{6}</a><span>进入房间</span></li>';j=d.stringFormat(j,this.headimg(k.levs),this.pclass(k.levs),k.userId,decodeURIComponent(k.nickname),this.spimg(k.levs),i,decodeURIComponent(k.nickname));$("#pubChatList").append(j);try{$("#nano-pubChatList").nanoScroller();$("#nano-pubChatList").nanoScroller({scroll:"bottom"})}catch(l){UIF.handler.weblog(l)}}},onAllMsg:function(j){if(UIF.thisHome==1){j.ctime=d.dateFormat(new Date(),"HH:mm");$.ajax({type:"POST",url:"/ajax/postChatMessage.php",data:j,cache:false,dataType:"json",async:false}).done(function(l){UIF.handler.weblog(j)})}var i='<li class="fontred"><span class="gr-time">'+d.dateFormat(new Date(),"HH:mm")+'  </span>{0}<a href="javascript:;" class="u{1}" rel="{2} {3} {4}">{5}</a>{6}</li>';words=f.faceReplaceImg(j.message);i=d.stringFormat(i,this.headimg(j.levs),this.pclass(j.levs),j.userId,decodeURIComponent(j.nickname),this.spimg(j.levs),decodeURIComponent(j.nickname)+"：",words);$("#pubChatList").append(i);try{$("#nano-pubChatList").nanoScroller();$("#nano-pubChatList").nanoScroller({scroll:"bottom"})}catch(k){UIF.handler.weblog(k)}},onPrvMsg:function(k){var m='<li class="fontred"><span class="gr-time">'+d.dateFormat(new Date(),"HH:mm")+'  </span>{0}<a href="javascript:;" class="u{1}" rel="{2} {3} {4}">{5}</a><span class="prwords">{6}：{7}</span></li>';var i=UIF.handler.cache.get(a.USER_HEADINFOS);var j=d.stringFormat("{0}",(i!=null&&i.userId==k.userId)?"":"对你说");words=f.faceReplaceImg(k.message);m=d.stringFormat(m,this.headimg(k.levs),this.pclass(k.levs),k.userId,decodeURIComponent(k.nickname),this.spimg(k.levs),decodeURIComponent(k.nickname),j,words);$("#priChatList").append(m);try{$("#nano-priChatList").nanoScroller();$("#nano-priChatList").nanoScroller({scroll:"bottom"})}catch(l){UIF.handler.weblog(l)}},onP2PMsg:function(k){var l='<li class="fontred"><span class="gr-time">'+d.dateFormat(new Date(),"HH:mm")+"  </span>{0}<span>{1}{2}：{3}</span></li>";var i=UIF.handler.cache.get(a.USER_HEADINFOS);var j=d.stringFormat("{0}",(i!=null&&i.userId==k.userId)?"":"对你说");words=f.faceReplaceImg(k.message);if(words.indexOf(":")>0){words=words.substring(words.indexOf(":")+1,words.length)}l=d.stringFormat(l,this.headimg(k.levs),decodeURIComponent(k.nickname),j,words);$("#priChatList").append(l)},onNotice:function(j){var k='<div class="roomIntro"><span class="gr-time">公告：{0}</span></div>';var i=(j!=null&&j.notice!=null)?j.notice:"";if(i!=null&&i.length>0){$("#priChatList").append(d.stringFormat(k,i))}},onFlyMsg:function(i){var j=i.nickname+"说："+i.message;b.fly(j)},runMsg:function(i){if(i.id=="hornLi"){var j=i.userName+"说："+i.content;h.rwMsgH(d.dateFormat(new Date(),"HH:mm"),{hornText:i.content,src_nickname:decodeURIComponent(i.userName)},f.replace_face(j))}else{if(i.id=="giftLi"){var j=i.userName+"在"+i.liverName+i.roomNumber+"的房间赠送了"+i.itemName+i.number;h.rwMsgGift(d.dateFormat(new Date(),"HH:mm"),{src_nickname:decodeURIComponent(i.userName),anchorsName:decodeURIComponent(i.liverName),roomid:decodeURIComponent(i.roomNumber),giftId:i.itemName,number:i.number},f.replace_face(j))}else{if(i.id=="guardLi"){var j=i.userName+"在"+i.liverName+i.roomNumber+"的房间升级为"+i.consumeLevel;h.rwMsgG(d.dateFormat(new Date(),"HH:mm"),{src_nickname:decodeURIComponent(i.userName),anchorsName:decodeURIComponent(i.liverName),roomid:decodeURIComponent(i.roomNumber),level:i.consumeLevel},f.replace_face(j))}else{if(i.id=="spenderLi"){var j="恭喜"+i.userName+"升级为"+i.consumeLevel;h.rwMsgS(d.dateFormat(new Date(),"HH:mm"),{level:decodeURIComponent(i.consumeLevel),src_nickname:decodeURIComponent(i.userName)},f.replace_face(j))}else{if(i.id==null){console.log("there is no data")}}}}}},banned:function(i){$("#sendChatBtn").attr("disabled",true);$("#msgContent").attr("disabled",true);d.dialog("你已被禁言！")},kickOut:function(i){self.location="/html/101.html"}}});define("flyScreen",[],function(c,a,e){var b=c("./anchor-tools");var d=c("./anchor-face");e.exports={flyRoad:[0,0,0,0,0,0,0,0],fly:function(k){var h=this;var o=["#fff","#f00","#0f0","#0ff"];var q=b.rand(0,o.length);var j=$('<marquee loop=1 scrollAmount=6 behavior="scroll" class="flyScreen"><table class="flycn"><tr><td style="color:'+o[q]+'">'+d.replace_face(k)+"</td></tr></table></marquee>");var f=0,g=true;for(var l=0;l<8;l++){if(0==h.flyRoad[l]){h.flyRoad[l]=1;f=l;g=false;break}}if(g){f=parseInt(Math.random()*8);h.flyRoad[f]=1}var m=f*50+60;j.css("top",m);$("body").append(j);var n=$(window).width()+j.children(".flycn").width();var q=n/0.065;var p=UIF.handler.ie6?q-10000:q;setTimeout(function(){j.remove();h.flyRoad[f]=0},p)}}});define("toproom",[],function(b,a,d){var c=b("./anchor-face");d.exports={rwMsgH:function(j,i,f){var g=$('<li id="hornLi"><div><label><span class="rwUser">'+i.src_nickname+' : </span><span class="chatContent">'+i.hornText+"</span></label></div></li>");var e=$("#ulid"),h=$(".list_top");e.append(g);h.slideDown();if($("#ulid li").length>1){e.children("li").first().remove()}setTimeout(function(){$("#ulid li").remove();$(".list_top").slideUp()},105000)},rwMsgS:function(j,i,f){var g=$('<li id="spenderLi"><div><label>恭喜 <span class="rwUser">'+i.src_nickname+' </span>升级为 <span class="upTit">'+i.level+"</span></label></div></li>");var e=$("#ulid"),h=$(".list_top");e.append(g);h.slideDown();if($("#ulid li").length>1){e.children("li").first().remove()}setTimeout(function(){$("#ulid li").remove();$(".list_top").slideUp()},105000)},rwMsgG:function(j,i,f){var g=$('<li id="guardLi"><div><label><span class="rwUser">'+i.src_nickname+' </span> 在 <a href="/'+i.roomid+'" target="_blank" class="anchor">'+i.anchorsName+'</a> 的房间升级为 <span class="upTit">'+i.level+"</span></label></div></li>");var e=$("#ulid"),h=$(".list_top");e.append(g);h.slideDown();if($("#ulid li").length>1){e.children("li").first().remove()}setTimeout(function(){$("#ulid li").remove();$(".list_top").slideUp()},105000)},rwMsgGift:function(j,i,f){var g=$('<li id="giftLi"><div><label><span class="rwUser">'+i.src_nickname+' </span> 在 <a href="/'+i.roomid+'" target="_blank" class="anchor">'+i.anchorsName+'</a> 的房间赠送了 <span class="gifts">'+i.giftId+" x"+i.number+"</span></label></a></li>");var e=$("#ulid"),h=$(".list_top");e.append(g);h.slideDown();if($("#ulid li").length>1){e.children("li").first().remove()}setTimeout(function(){$("#ulid li").remove();$(".list_top").slideUp()},105000)},formatLuckNum:function(e){if(+e){return'<span class="fluck">('+e+")</span>"}else{return""}}}});