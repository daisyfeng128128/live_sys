define(function(d,b,e){var a=d("cons");var f=d("map");var c=d("./anchor-tools");e.exports={page:0,init:function(h){var g=this;$(".aud").click(function(){g.page=0;$(".audience").css({opacity:0,display:"block"}).animate({left:70,opacity:1},500,"swing",function(i){$(this).addClass("bg-show");g.flushUsers()})});$(".nexp").on("click",function(){g.page++;var i=g.getUserlist(g.page);if(i!=null&&i!=undefined){g.addToUsers(i)}});$(".viewer").on("click",function(){g.page=0;if($(this).hasClass("on")){g.flushUsers();return !1}$(".manager").removeClass("on"),$(this).addClass("on"),$(".viewer-list").show(),$(".manager-list").hide()});$(".manager").on("click",function(){g.flushManagers();if($(this).hasClass("on")){return !1}$(".viewer").removeClass("on"),$(this).addClass("on"),$(".manager-list").show(),$(".viewer-list").hide()})},welcome:function(g){UIF.handler.weblog(JSON.stringify(g)+"进入")},addUsers:function(g){if(!UIF.handler.userList.containsKey(g.userId)){UIF.handler.userList.put(g.userId,g);if(UIF.handler.userList.size()>20){$(".nexp").show()}else{$(".nexp").hide()}}},getUserlist:function(k){var h=UIF.handler.userList;var l=new f;var g=20+k*5;if(h.size()<g){return false}if(h.size()>0){for(var j=g-5;j<g;j++){l.put(h.elements[j].key,h.elements[j].value)}}return l},addToUsers:function(i){var h=this;if(i==null||i==""||i==undefined){return false}var g=this.parseHtml(i);$(".usersList").append(g);$(".viewer-list").nanoScroller();$(".viewer-list").nanoScroller({scroll:"bottom"})},parseHtml:function(p){if(p==null||p==""||p==undefined){return false}var o=this;var k='<li data-cardid="{0}" class="anchor">							<span class="ICON-noble-level ICON-nl-13"></span>							<i class="ICON-medal">{1}</i>							<span class="name" title="{2}">{3}</span>					  </li>';var n="";var g=p.values();for(var m=0;m<g.length;m++){for(var h=0;h<g.length;h++){if(parseInt(g[m].splev)>parseInt(g[h].splev)){var l=g[m];g[m]=g[h];g[h]=l}}}g.forEach(function(j){var i=j.levs;if(i!=null&&i.indexOf("pic_liverlevel")>0){n+=c.stringFormat(k,j.userId,o.headimg(j.levs),decodeURIComponent(j.nickname),decodeURIComponent(j.nickname))}});g.forEach(function(j){var i=j.levs;if(i!=null&&i.indexOf("pic_liverlevel")<0){n+=c.stringFormat(k,j.userId,o.headimg(j.levs),decodeURIComponent(j.nickname),decodeURIComponent(j.nickname))}});return n},flushUsers:function(){var o=this;var k='<li data-cardid="{0}" class="anchor">							<span class="ICON-noble-level ICON-nl-13"></span>							<i class="ICON-medal">{1}</i>							<span class="name" title="{2}">{3}</span>					  </li>';var n="";var g=UIF.handler.userList.values();for(var m=0;m<g.length;m++){for(var h=0;h<g.length;h++){if(parseInt(g[m].splev)>parseInt(g[h].splev)){var l=g[m];g[m]=g[h];g[h]=l}}}g.forEach(function(p,i){if(i>20){return !1}var j=p.levs;if(j!=null&&j.indexOf("pic_liverlevel")>0){n+=c.stringFormat(k,p.userId,o.headimg(p.levs),decodeURIComponent(p.nickname),decodeURIComponent(p.nickname))}});g.forEach(function(p,i){if(i>20){return !1}var j=p.levs;if(j!=null&&j.indexOf("pic_liverlevel")<0){n+=c.stringFormat(k,p.userId,o.headimg(p.levs),decodeURIComponent(p.nickname),decodeURIComponent(p.nickname))}});$(".usersList").html(n);$(".viewer-list").nanoScroller();$(".viewer-list").nanoScroller({scroll:"bottom"})},flushBuUsers:function(h){var j=this;var g='<li data-cardid="{0}" class="anchor">							<span class="ICON-noble-level ICON-nl-13"></span>							<i class="ICON-medal">{1}</i>							<span class="name" title="{2}" style="font-size: 12px;">{3}</span>					  </li>';var i="";if(h!=null){values=h}else{values=UIF.handler.userList.values()}values=c.uniqueArrayKey(values,"userId");values=values.sort(c.sortBy("levs",1));values.forEach(function(m,l){if(m.userId!=null&&m.userId==UIF.handler.anchorId){i+=c.stringFormat(g,m.userId,j.headimg(m.levs),decodeURIComponent(m.nickname),decodeURIComponent(m.nickname))}});values.forEach(function(m,l){if(m.userId!=null&&m.userId!=UIF.handler.anchorId){i+=c.stringFormat(g,m.userId,j.headimg(m.levs),decodeURIComponent(m.nickname),decodeURIComponent(m.nickname))}});$("#song_item").html(i);try{$("#nano-guardList").nanoScroller()}catch(k){UIF.handler.weblog(k)}},flushManagers:function(){var o=this;var p='<li data-cardid="{0}" class="anchor">						<span class=""></span>						<i class="ICON-medal">{1}</i>						<span class="name" title="{2}">{3}</span>					</li>';var m="";var g=UIF.handler.userList.values();for(var l=0;l<g.length;l++){for(var h=0;h<g.length;h++){if(g[l].splev<g[h].splev){var k=g[h];g[h]=g[h];g[h]=k}}}var n=0;g.forEach(function(j){var i=j.levs;if(i!=null&&i.indexOf("pic_guanli")>0){m+=c.stringFormat(p,j.userId,o.headimg(j.levs),decodeURIComponent(j.nickname),decodeURIComponent(j.nickname));n=n+1}});$(".managerList").html(m);$(".manager-list").nanoScroller();$(".manager-list").nanoScroller({scroll:"bottom"});$(".manager>span").text(n)},headimg:function(m){var l="";var g='<span class="{0}"></span>';try{var h=jQuery.parseJSON(m)}catch(n){var h=""}if(h!=null&&h.length>0){for(var k=0;k<h.length;k++){var j=h[k];if(j!=null&&j!=""&&(j.indexOf("pic_consumelevel")>0||j.indexOf("pic_activelevel")>0||j.indexOf("pic_relationlevel")>0||j.indexOf("pic_liverlevel")>0||j.indexOf("pic_guanli")>0)){l+=c.stringFormat(g,j)}}}return l}}});