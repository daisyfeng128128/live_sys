<?php $type=(int)$_GET['type'];$roomnumber=(int)$_GET['roomnumber'];$userid=$_GET['userid'];include('../include/header.inc.php');include($app_path."include/level.func.php");//插入的机器人数//$bot_count = $db->GetOne("select value from gameconfig where name='bot_count'");//$bot_count = (int)$bot_count;//$db->debug = true;$bot_count=0;if($type==1){        $queryuid=$userid;        if(strlen($userid)==13){                $queryuid=0;        }        $arr=$db->GetRow("select b.usernumber as anum,b.totalcost,b.userid,b.viplevel,b.usernumber,b.islianghao,b.nickname,b.xinren,b.xinren_vailddate,b.fontsize,b.fontcolor,b.fontfamily,b.fontweight,b.fontstyle from user b where b.userid='$queryuid'");		if(empty($arr)){			$arr['blocklevel'] = "0";			$usernum=$userid;			$arr['usernumber']=$userid;			$arr['anum']=$userid;			$arr['totalcost']="";			$arr['userid']="0";			$arr['nickname']="";			$arr['viplevel']="0";			$arr['richlevel']="0";			$arr['islianghao']="0";		}else{			$arr['blocklevel'] = "0";			$usernum=$arr['usernumber'];			//判断是否有权设置字体			if(!($arr['viplevel']>0 || isRoomGuard($roomnumber,$arr))){				$arr['fontfamily'] = "12";				$arr['fontsize'] = "宋体";				$arr['fontweight'] = "0";				$arr['fontstyle'] = "0";				$arr['fontcolor'] = "000000";			}			//判断是否被踢出房间			$blocklevel=$db->CacheGetOne(0,"select a.level from blacklist a,user b where a.roomnumber='$roomnumber' and a.userid=b.userid and (a.userid='$userid') and a.endtime>".time());			$blocklevel=(int)$blocklevel;			if($blocklevel=="1"){				$arr['blocklevel'] = "1";			}		}		if($arr['nickname']==""){			$arr['nickname']="游客_".substr($arr['anum'],-5);		}		$arr['richlevel']=cost2rich($arr['totalcost']);        $cost=(int)$arr['totalcost'];		$hideself = $db->GetOne("select count(*) from hideself where roomnumber='$roomnumber' and userid='$userid'");        $ishide=0;        if($hideself!=0){        	$ishide=1;        	$state="hide";        }        else{        	$state="show";        }		if($arr['blocklevel']!="1"){			$db->Execute("INSERT INTO `show_users` (`usernumber` ,`roomnumber` ,`totalcost`,`userid`,`ishide`)VALUES ('$usernum', '$roomnumber', '$cost','{$arr['userid']}','$ishide')");		}        //file_put_contents('/tmp/aa.txt',"INSERT INTO `huofen`.`show_users` (`usernumber` ,`roomnumber` ,`totalcost`)VALUES ('$usernum', '$roomnumber', '$cost')");		//如果是主播,把没有结束的,但是已经有lastdisconnect的去掉		$db->Execute("update shows set lastdisconnect=null where endtime is null and userid='$userid'");        //查询这个人有没有座驾		if($queryuid!=0 && $state=="show"){			//输出的是:车名|车图片|是否为新人			$result=$db->GetRow("select a.* from gift a,usercars b where b.carid=a.giftid and b.userid=$queryuid and b.vailddate>".time()." order by b.active desc,a.giftprice desc");			if(empty($result)){				$result['giftid']="";				$result['giftname']="";				$result['giftimage']="";			}			if($arr['xinren']>="1"&&$arr['xinren_vailddate']>time()){				$xinren=$arr['xinren'];			}else{				$xinren="0";			}		}		unset($arr['xinren']);		unset($arr['xinren_vailddate']);		/*		if($arr['accountfrom']=='9'){//只有是机器人进入才会随机一个机器人来说话			include_once($app_path.'ajax/botwords.php');			$botinfo=$db->GetRow("SELECT b.usernumber,b.nickname FROM show_users a, user b WHERE a.userid=b.userid and b.accountfrom=9 AND a.roomnumber=$roomnumber order by rand() LIMIT 1");			$botwords=array('nickname'=>$arr['nickname'],'usernumber'=>$arr['usernumber'],'botwords'=>$botwords[rand(0,(count($botwords)-1))]);		}else{			$botwords = null;		}		*/		$botwords = null;		$arr['orderbyjs']=orderbyjs($arr);		unset($arr['totalcost']);		//unset($arr['anum']);		echo json_encode ( array (			"userinfo" => $arr,			"botwords" => $botwords,			'car' => array (				"state" => $state,				"giftname" => empty($result ['giftname'])?"":$result ['giftname'],				"giftimage" => $result ['giftimage'],				"giftid" => $result ['giftid'],				"xinren" => empty($xinren)?"0":$xinren 			) 	) );	//inRoomBot($roomnumber,$bot_count);}else{	$db->Execute("delete from `show_users` where (userid='$userid' or (usernumber='$userid' and userid='0')) and roomnumber='$roomnumber' limit 1");	$un=$db->GetOne("select usernumber from user where userid='$userid'");	$db->Execute("delete from showerOrder where roomnumber='$roomnumber' and usernumber='$un'");	if($un==$roomnumber){		$db->Execute("update shows set lastdisconnect='".time()."' where endtime is null and userid='$userid'");	}}//排序等级function orderbyjs($arr){	if(strlen($arr['anum'])==13){		return -1;    }	return ($arr['viplevel'])*100+$arr['richlevel'];}include('../include/footer.inc.php');/** * 插入1个机器人 */function inRoomBot($showid,$count = 0){	if(empty($count) || empty($showid))		return;		global $db;	$data=$db->GetArray("select userid,totalcost,usernumber from user where accountfrom=9 order by rand() limit $count");	foreach ($data as $user) {		$db->Execute("insert into show_users values('$user[usernumber]','$showid','$user[totalcost]','$user[userid]',0,NULL)");	}}/** * 删除1个机器人 */function quitRoomBot($showid,$count = 0){	if(empty($count) || empty($showid))		return;		global $db;	$data=$db->GetArray("SELECT a.userid,a.roomnumber from show_users a,user b where a.userid=b.userid and b.isshowing=0 and b.accountfrom=9 and a.roomnumber='$showid' order by rand() limit $count");	foreach ($data as $user) {		$narr[]=$user["userid"];	}	if(empty($narr))return;		$userids=join(',',$narr);	if(!empty($userids))		$db->Execute("delete from show_users where userid not in($userids) and roomnumber='$showid'");}